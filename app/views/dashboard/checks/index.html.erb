<% if @show_coverage_upload_instruction %>
  💁‍♂️ Complete your setup and integrate UncercoverCI with your test suite
  <%= render partial: "partials/coverage_upload_instruction" %>
<% end %>

<p class="lead">Recently analysed commits</p>

<div class="mb-5">
  <div class="row mb-5">
    <div class="col-lg-3">
      <%=
        select_tag(
          :repository_name,
          options_for_select(@repository_names),
          class: "form-select",
          aria_label: "Repository"
        )
      %>
    </div>
    <div class="col-lg-3">
      <select class="form-select" aria-label="Branch">
        <option selected>All branches</option>
      </select>
    </div>
    <div class="col-lg-3">
      <select class="form-select" aria-label="Date range">
        <option selected>Last 30d</option>
      </select>
    </div>
    <div class="col-lg-3 text-end">
      <div class="btn-group" role="group" aria-label="Basic example">
        <button type="button" class="btn btn-outline-primary">All</button>
        <button type="button" class="btn btn-outline-primary">Failed</button>
        <button type="button" class="btn btn-outline-primary">Passed</button>
      </div>
    </div>
  </div>

  <div class="mb-5">
    <%=
      # TODO: move to an async controller
      line_chart(
        # TODO: add options (scope to installations, date range etc)
        CoverageCheck.to_chartkick(),
        # xmin: "2023-11-17",
        # xmax: "2023-11-26",
        xtitle: "date", ytitle: "total checks", legend: false
      )
    %>
  </div>

  <table class="table table-hover">
    <thead>
      <tr>
        <!-- TODO: update columns: show commit message -->
        <th>Repo</th>
        <th>Commit</th>
        <th>Coverage</th>
        <th>State</th>
      </tr>
    </thead>
    <tbody>
      <% @checks.each do |check| %>
        <tr class="row-href" data-href="<%= check_path(check.id) %>">
          <td><%= check.repo_full_name %></td>
          <td>
            <code><%= pull_request_or_commit_link(check) %></code>
          </td>
          <td>
            <%= coverage_result_badge(check) %>
          </td>
          <td title="<%= check.state_log.last&.fetch("ts") %>">
            <% if check.state != :created %>
              <%= "#{check.state} (#{distance_of_time_in_words(Time.now, check.state_log.last&.fetch("ts"), include_seconds: true)} ago)" %>
            <% else %>
              <%= check.state %>
            <% end %>
          </td>
        </tr>
      <% end %>
      <% if @checks.none? %>
        <tr><td colspan=3><span>No data yet</span></td></tr>
      <% end %>
    </tbody>
  </table>
  <div class="d-flex justify-content-center">
    <%= paginate @checks, theme: "bootstrap-5" %>
  </div>
</div>
